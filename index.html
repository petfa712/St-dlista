<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StädKoll - Din Interaktiva Städpartner</title>
    
    <!-- App-inställningar för Android & iOS -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8fafc">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .checked-text { text-decoration: line-through; color: #94a3b8; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24 text-slate-900">

    <!-- Header -->
    <header class="bg-white border-b sticky top-0 z-10 px-4 py-3 flex justify-between items-center shadow-sm">
        <div class="flex flex-col">
            <h1 class="text-xl font-bold text-slate-800 uppercase tracking-tight">Städlista</h1>
            <div class="flex items-center gap-2">
                <span id="sync-status" class="text-[10px] text-amber-500 font-bold uppercase tracking-wide font-mono">Lokalt</span>
                <span id="today-suggestion" class="text-[10px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-black uppercase tracking-tighter"></span>
            </div>
        </div>
        <div id="week-selector-ui" class="flex gap-1 bg-slate-100 p-1 rounded-lg">
            <button onclick="autoSetWeek()" class="px-2 py-1 text-[10px] font-bold text-blue-600 hover:bg-white rounded transition-all uppercase">Auto</button>
            <div class="w-px h-4 bg-slate-200 self-center mx-1"></div>
            <button onclick="setWeek(1)" id="btn-v1" class="px-3 py-1 text-xs rounded-md transition-all">V1</button>
            <button onclick="setWeek(2)" id="btn-v2" class="px-3 py-1 text-xs rounded-md transition-all">V2</button>
            <button onclick="setWeek(3)" id="btn-v3" class="px-3 py-1 text-xs rounded-md transition-all">V3</button>
            <button onclick="setWeek(4)" id="btn-v4" class="px-3 py-1 text-xs rounded-md transition-all">V4</button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-content" class="p-4 max-w-lg mx-auto space-y-4">
        <!-- Innehåll laddas via JS -->
    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center h-16 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <button onclick="switchView('weekly')" id="nav-weekly" class="flex flex-col items-center gap-1 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span class="text-[10px] font-bold uppercase">Vecka</span>
        </button>
        <button onclick="switchView('seasonal')" id="nav-seasonal" class="flex flex-col items-center gap-1 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span class="text-[10px] font-bold uppercase">Säsong</span>
        </button>
        <button onclick="switchView('profile')" id="nav-profile" class="flex flex-col items-center gap-1 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span class="text-[10px] font-bold uppercase">Profil</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // ==========================================
        // KONFIGURATION (Klistra in din nyckel här)
        // ==========================================
        const defaultFirebaseConfig = const defaultFirebaseConfig = {
            apiKey: "AIzaSyAZkTPNGWC29HQ9fz4Zr8vK8Cfb4VYV6YA",
            authDomain: "cleaning-3064f.firebaseapp.com",
            projectId: "cleaning-3064f",
            storageBucket: "cleaning-3064f.firebasestorage.app",
            messagingSenderId: "1079173197088",
            appId: "1:1079173197088:web:88bc7ef22bb1c1cfebfb45"
        };

        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) 
            ? JSON.parse(__firebase_config) 
            : defaultFirebaseConfig;

        const appId = 'stadkoll-app-v3';
        
        const cleaningData = {
            weekly: [
                { id: 'mon', name: 'Måndag', short: 'Mån', color: '#3b82f6', tasks: ['Rengör spis & bänk', 'Sopsortering', 'Diskho'], laundry: 'Handdukar', rotation: {
                    v13: ['Rengör mikron', 'Smutsiga handtag'],
                    v2: ['Tvätta grytlappar', 'Diskmaskin + filter'],
                    v4: ['Under diskbänken', 'Vattenlås (medel)', 'Rengör kranen']
                }},
                { id: 'tue', name: 'Tisdag', short: 'Tis', color: '#9333ea', tasks: ['Toalett', 'Putsa speglar', 'Handfat', 'Robotdammsugare'], laundry: '40°/30°', rotation: {
                    v13: ['Skrubba duschen'],
                    v2: ['Badrumsmatta', 'Toalett noggrant'],
                    v4: ['Koka tandborste']
                }},
                { id: 'wed', name: 'Onsdag', short: 'Ons', color: '#10b981', tasks: ['Damma ytor', 'Piffa kuddar/filtar'], laundry: 'Träningskläder', rotation: {
                    v13: ['Lister & dörrar'],
                    v2: ['Lampor & ventiler'],
                    v4: ['Bokhyllor', 'Damma tomma rum']
                }},
                { id: 'thu', name: 'Torsdag', short: 'Tor', color: '#f59e0b', tasks: ['Töm roboten', 'Dammsuga'], laundry: 'Vit / underkläder', rotation: {
                    v13: ['Dammsuga soffan', 'Dammsuga sänggavel', 'Dammsuga under sängen'],
                    v4: ['Dammsuga tomma rum noggrant', 'Moppa golven ordentligt']
                }},
                { id: 'fri', name: 'Fredag', short: 'Fre', color: '#f43f5e', tasks: ['Byt sängkläder', 'Robot', 'Helgpiff'], laundry: 'Sängkläder', rotation: {
                    v2: ['Slänga trasor & svampar'],
                    v4: ['Tvättmaskinsrengöring']
                }}
            ],
            seasonal: [
                { id: 'spring', name: 'Vår (Mar/Apr)', color: '#10b981', tasks: ['Putsa fönster', 'Balkongstäd', 'Plantera om', 'Tvätta täcken', 'Vinter ut / Sommar in'], deep: ['Tvätta soffan', 'Under stora möbler', 'Piska mattan', 'Tvätta gardiner', 'Rensa förråd'] },
                { id: 'summer', name: 'Sommar (Jun/Jul)', color: '#0ea5e9', tasks: ['Torka väggar', 'Lampor', 'Element'], deep: ['Under maskiner', 'Skåp tvättstuga', 'Skåp badrum', 'Borsta fogar', 'Avkalka dusch'] },
                { id: 'autumn', name: 'Höst (Sep/Okt)', color: '#f97316', tasks: ['Putsa fönster', 'Städa balkong', 'Tvätta täcken', 'Sommar ut / Vinter in', 'Hall: Slask-prep'], deep: ['Garderob', 'Byrå & hyllor', 'Klädkammare', 'Extrarum noggrant'] },
                { id: 'winter', name: 'Vinter (Dec/Jan)', color: '#6366f1', tasks: ['Kontrollera lister', 'Frosta av frys'], deep: ['Köksskåp', 'Bakom kyl/ugn', 'Bokhyllor', 'Garderob: Rensa'] }
            ],
            quarterly: ['Fläktfilter', 'Ugnen', 'Kylen', 'Vattenlås', 'Madrasskydd', 'Gör rent madrass', 'Soffa & fåtölj', 'Byt tandborste', 'Avkalka']
        };

        const getSuggestedWeek = () => {
            const date = new Date().getDate();
            if (date <= 7) return 1;
            if (date <= 14) return 2;
            if (date <= 21) return 3;
            return 4;
        };

        // State Init
        let currentView = 'weekly';
        let currentWeek = getSuggestedWeek();
        let currentDayId = ['sun','mon','tue','wed','thu','fri','sat'][new Date().getDay()] || 'mon';
        if (currentDayId === 'sun' || currentDayId === 'sat') currentDayId = 'fri';
        let currentSeasonId = localStorage.getItem('current_season') || 'spring';
        
        let checkedItems = JSON.parse(localStorage.getItem('cleaning_local_v3')) || {};
        let currentUser = null;
        let db = null;
        let auth = null;
        let unsubscribeSync = null;
        let isCloudConnected = false;
        let authStatus = { loading: false, message: '', type: '' };

        // UI Functions
        window.switchView = (view) => { currentView = view; render(); };
        window.setWeek = (w) => { currentWeek = w; render(); };
        window.autoSetWeek = () => { currentWeek = getSuggestedWeek(); render(); };
        window.setDay = (dayId) => { currentDayId = dayId; render(); };
        window.toggleItem = async (id) => {
            checkedItems[id] = !checkedItems[id];
            localStorage.setItem('cleaning_local_v3', JSON.stringify(checkedItems));
            render();
            await syncToCloud();
        };

        // Auth Logic
        window.handleAuth = async (mode) => {
            if (!auth) return alert("Firebase saknas");
            const user = document.getElementById('auth-user').value.trim();
            const pass = document.getElementById('auth-pass').value;
            
            if(!user || !pass) {
                authStatus = { loading: false, message: "Fyll i både namn och lösenord.", type: "error" };
                render();
                return;
            }

            const email = `${user.toLowerCase()}@stad.app`;
            authStatus = { loading: true, message: mode === 'login' ? "Loggar in..." : "Skapar konto...", type: "info" };
            render();

            try {
                if(mode === 'login') {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    await createUserWithEmailAndPassword(auth, email, pass);
                }
                // onAuthStateChanged sköter resten av UI-uppdateringen
            } catch (e) {
                console.error(e);
                let msg = "Ett fel uppstod.";
                if (e.code === 'auth/user-not-found') msg = "Användaren hittades inte.";
                if (e.code === 'auth/wrong-password') msg = "Fel lösenord.";
                if (e.code === 'auth/email-already-in-use') msg = "Användarnamnet är upptaget.";
                authStatus = { loading: false, message: msg, type: "error" };
                render();
            }
        };

        window.handleLogout = async () => {
            if (auth) await signOut(auth);
            checkedItems = {};
            localStorage.removeItem('cleaning_local_v3');
            location.reload();
        };

        const syncToCloud = async () => {
            // Spara lokalt
            localStorage.setItem('cleaning_local_v3', JSON.stringify(checkedItems));
            
            // Spara i molnet endast om användaren är inloggad med ett RIKTIGT konto
            if (!currentUser || currentUser.isAnonymous || !db || !isCloudConnected) return;
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'cleaningData', 'state');
                await setDoc(docRef, { items: checkedItems }, { merge: true });
            } catch (e) { console.warn("Cloud sync failed/paused"); }
        };

        const render = () => {
            const container = document.getElementById('app-content');
            if (!container) return;
            container.innerHTML = '';
            
            document.getElementById('nav-weekly').className = `flex flex-col items-center gap-1 transition-colors ${currentView === 'weekly' ? 'text-blue-600' : 'text-slate-400'}`;
            document.getElementById('nav-seasonal').className = `flex flex-col items-center gap-1 transition-colors ${currentView === 'seasonal' ? 'text-blue-600' : 'text-slate-400'}`;
            document.getElementById('nav-profile').className = `flex flex-col items-center gap-1 transition-colors ${currentView === 'profile' ? 'text-blue-600' : 'text-slate-400'}`;
            document.getElementById('week-selector-ui').style.display = currentView === 'weekly' ? 'flex' : 'none';

            if (currentView === 'weekly') renderWeekly(container);
            else if (currentView === 'seasonal') renderSeasonal(container);
            else renderProfile(container);
        };

        function renderWeekly(container) {
            const tabs = document.createElement('div');
            tabs.className = "flex overflow-x-auto gap-2 mb-4 no-scrollbar pb-1";
            cleaningData.weekly.forEach(day => {
                const btn = document.createElement('button');
                btn.className = `px-5 py-2 rounded-full text-xs font-bold transition-all ${currentDayId === day.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-slate-500 border'}`;
                btn.innerText = day.short;
                btn.onclick = () => window.setDay(day.id);
                tabs.appendChild(btn);
            });
            container.appendChild(tabs);

            const day = cleaningData.weekly.find(d => d.id === currentDayId);
            const card = document.createElement('div');
            card.className = "card bg-white rounded-xl card-shadow border-t-4 mb-4";
            card.style.borderTopColor = day.color;
            let html = `<div class="p-4"><div class="flex justify-between items-center mb-3"><h3 class="font-bold uppercase text-slate-800">${day.name}</h3><span class="text-[10px] font-bold text-slate-400">VECKA ${currentWeek}</span></div><div class="space-y-2.5">`;
            day.tasks.forEach((t, i) => html += renderItemHtml(`${day.id}-t-${i}`, t));
            const rotKey = currentWeek === 4 ? 'v4' : (currentWeek === 2 ? 'v2' : 'v13');
            const rotTasks = day.rotation[rotKey] || [];
            if (rotTasks.length > 0) {
                html += `<div class="mt-2 pt-2 border-t"><p class="text-[9px] font-black text-slate-300 uppercase mb-2">Rotation (${rotKey.toUpperCase()})</p>`;
                rotTasks.forEach((t, i) => html += renderItemHtml(`${day.id}-r-${rotKey}-${i}`, t));
                html += `</div>`;
            }
            html += `<div class="py-2 border-t mt-2 flex items-center gap-3" onclick="toggleItem('${day.id}-l')"><div class="w-5 h-5 rounded border-2 flex items-center justify-center ${checkedItems[day.id+'-l'] ? 'bg-blue-500 border-blue-500' : 'border-slate-300'}">${checkedItems[day.id+'-l'] ? '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M5 13l4 4L19 7"/></svg>' : ''}</div><span class="text-sm italic text-blue-600 ${checkedItems[day.id+'-l'] ? 'checked-text' : ''}">Tvätt: ${day.laundry}</span></div></div></div>`;
            card.innerHTML = html;
            container.appendChild(card);
        }

        function renderSeasonal(container) {
            const tabs = document.createElement('div');
            tabs.className = "flex overflow-x-auto gap-2 mb-4 no-scrollbar pb-1";
            cleaningData.seasonal.forEach(s => {
                const btn = document.createElement('button');
                btn.className = `px-5 py-2 rounded-full text-xs font-bold transition-all ${currentSeasonId === s.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-slate-500 border'}`;
                btn.innerText = s.name.split(' ')[0];
                btn.onclick = () => { currentSeasonId = s.id; localStorage.setItem('current_season', s.id); render(); };
                tabs.appendChild(btn);
            });
            container.appendChild(tabs);
            const season = cleaningData.seasonal.find(x => x.id === currentSeasonId);
            const contentDiv = document.createElement('div');
            contentDiv.className = "space-y-4";
            let sHtml = `<div class="card bg-white rounded-xl card-shadow p-4 border-l-4" style="border-left-color:${season.color}"><h3 class="font-bold text-[10px] uppercase mb-3" style="color:${season.color}">${season.name}</h3><div class="space-y-2.5">`;
            season.tasks.forEach((t, i) => sHtml += renderItemHtml(`${season.id}-st-${i}`, t));
            sHtml += `<div class="border-t my-4 pt-4"><p class="text-[9px] font-bold text-slate-300 uppercase mb-2">Deep Clean</p>`;
            season.deep.forEach((t, i) => sHtml += renderItemHtml(`${season.id}-sd-${i}`, t));
            sHtml += `</div></div></div>`;
            let qHtml = `<div class="card bg-white rounded-xl card-shadow p-4 border-l-4 border-l-slate-400"><h3 class="font-bold text-slate-400 text-[10px] uppercase mb-3">Kvartalsfix</h3><div class="space-y-2.5">`;
            cleaningData.quarterly.forEach((t, i) => qHtml += renderItemHtml(`q-${i}`, t));
            qHtml += `</div></div>`;
            contentDiv.innerHTML = sHtml + qHtml;
            container.appendChild(contentDiv);
        }

        function renderProfile(container) {
            if (!firebaseConfig) {
                container.innerHTML = `<div class="card bg-white rounded-xl card-shadow p-6 text-center w-full animate-fade-in"><h2 class="font-bold text-lg text-rose-600 mb-2">Konfiguration saknas</h2><p class="text-xs text-slate-500">Appen körs i offline-läge.</p></div>`;
                return;
            }
            if (currentUser && !currentUser.isAnonymous && isCloudConnected) {
                const name = currentUser.email.split('@')[0];
                container.innerHTML = `
                    <div class="card bg-white rounded-xl card-shadow p-6 text-center w-full animate-fade-in">
                        <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        </div>
                        <h2 class="font-bold text-lg capitalize mb-1">${name}</h2>
                        <p class="text-xs text-green-600 font-bold mb-6 italic tracking-widest uppercase">Molnsync Aktiv</p>
                        <button onclick="handleLogout()" class="w-full py-3 bg-rose-50 text-rose-600 rounded-xl font-bold text-sm hover:bg-rose-100 transition-colors">Logga ut</button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="card bg-white rounded-xl card-shadow p-6 w-full animate-fade-in">
                        <h2 class="font-bold text-xl mb-1">Ditt Konto</h2>
                        <p class="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-6">Logga in för att synka mellan enheter</p>
                        
                        <div class="space-y-4">
                            <input id="auth-user" type="text" placeholder="Användarnamn" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-blue-500 transition-all">
                            <input id="auth-pass" type="password" placeholder="Lösenord" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-blue-500 transition-all">
                            
                            ${authStatus.message ? `<div class="p-2 rounded text-[11px] font-bold text-center ${authStatus.type === 'error' ? 'bg-rose-50 text-rose-600' : (authStatus.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-blue-50 text-blue-600')}">${authStatus.message}</div>` : ''}

                            <div class="grid grid-cols-2 gap-3 pt-2">
                                <button onclick="handleAuth('login')" class="py-3 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                    ${authStatus.loading ? '<div class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>' : ''}
                                    Logga in
                                </button>
                                <button onclick="handleAuth('register')" class="py-3 bg-slate-100 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-200 transition-colors">
                                    Skapa konto
                                </button>
                            </div>
                        </div>
                        <p class="text-[10px] text-center text-slate-300 mt-6 italic uppercase">Utan konto sparas listan bara i denna mobil.</p>
                    </div>
                `;
            }
        }

        function renderItemHtml(id, text) {
            const isChecked = checkedItems[id];
            return `<div class="flex items-center gap-3 py-0.5" onclick="toggleItem('${id}')"><div class="w-5 h-5 rounded border-2 flex-shrink-0 flex items-center justify-center transition-all ${isChecked ? 'bg-slate-400 border-slate-400 scale-95' : 'border-slate-300'}">${isChecked ? '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M5 13l4 4L19 7"/></svg>' : ''}</div><span class="text-sm text-slate-600 font-medium leading-tight ${isChecked ? 'checked-text' : ''}">${text}</span></div>`;
        }

        const initFirebase = async () => {
            const statusEl = document.getElementById('sync-status');
            if (!firebaseConfig) { statusEl.innerText = "Lokalt"; render(); return; }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await enableIndexedDbPersistence(db).catch(() => {});

                onAuthStateChanged(auth, async (user) => {
                    // Om vi nyss loggat in via form-knapparna, visa succé en kort stund
                    if (user && !user.isAnonymous && authStatus.loading) {
                        authStatus = { loading: false, message: "Inloggad!", type: "success" };
                    } else if (!user) {
                        // Inget konto? Kör anonymt i bakgrunden (för unikt ID)
                        signInAnonymously(auth).catch(() => {});
                        return;
                    }
                    
                    currentUser = user;
                    
                    if (user.isAnonymous) {
                        isCloudConnected = false;
                        statusEl.innerText = "Lokal lagring";
                        statusEl.className = "text-[10px] text-slate-400 font-bold uppercase";
                    } else {
                        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'cleaningData', 'state');
                        if(unsubscribeSync) unsubscribeSync();
                        
                        unsubscribeSync = onSnapshot(docRef, (docSnap) => {
                            isCloudConnected = true;
                            statusEl.innerText = user.email.split('@')[0];
                            statusEl.className = "text-[10px] text-green-500 font-bold uppercase truncate max-w-[80px]";
                            
                            if (docSnap.exists()) {
                                const cloudItems = docSnap.data().items || {};
                                checkedItems = { ...checkedItems, ...cloudItems };
                                localStorage.setItem('cleaning_local_v3', JSON.stringify(checkedItems));
                            }
                            render();
                        }, (err) => {
                            isCloudConnected = false;
                            statusEl.innerText = "Behörighet saknas";
                            statusEl.className = "text-[10px] text-rose-500 font-bold uppercase";
                            render();
                        });
                    }
                    render();
                });
            } catch (e) { 
                statusEl.innerText = "Offline"; 
                render();
            }
        };

        document.getElementById('today-suggestion').innerText = `Idag: V${getSuggestedWeek()}`;
        initFirebase();
        // Rendera direkt för att slippa laddnings-skärm
        render();
    </script>
</body>
</html>
